ifndef BUNDLE_IMAGE
BUNDLE_IMAGE=quay.io/app-sre/deployment-validation-operator-bundle
endif

ifndef BUNDLE_IMAGE_TAG
BUNDLE_IMAGE_TAG=latest
endif

ifndef OPERATOR_IMAGE
OPERATOR_IMAGE=quay.io/app-sre/deployment-validation-operator
endif

ifndef OPERATOR_IMAGE_TAG
OPERATOR_IMAGE_TAG=latest
endif

MANIFEST_DIR=manifests
CSV=${MANIFEST_DIR}/deploymentvalidationoperator.clusterserviceversion.yaml

all: image

manifest:
	@mkdir -p $(MANIFEST_DIR) ; \
	TEMPLATE=`mktemp` ; \
	./generate-csv-template.py > $${TEMPLATE} ; \
	oc process --local -o yaml --raw=true IMAGE=$(OPERATOR_IMAGE) IMAGE_TAG=$(OPERATOR_IMAGE_TAG) VERSION=$(VERSION) REPLACE_VERSION=$(REPLACE_VERSION) -f $${TEMPLATE} > $(CSV)
	@if [ "${REPLACE_VERSION}" == "" ]; then \
	  sed -i.bak "/replaces/d" $(CSV); \
	  rm -f $(CSV).bak; \
	fi

bundle: manifest
	docker build -t ${BUNDLE_IMAGE}:${BUNDLE_IMAGE_TAG} .

push: bundle
	docker push ${BUNDLE_IMAGE}:${BUNDLE_IMAGE_TAG}

clean:
	rm -rf ${MANIFEST_DIR}
